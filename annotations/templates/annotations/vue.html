{% extends "annotations/base.html" %}
{% load staticfiles %}

<!-- <html>
    <head> -->
        {% block extrahead %}

        <script src="{% static "annotations/js/vue.min.js" %}"></script>
        <script src="{% static "annotations/js/tiny-cookie.min.js" %}"></script>

        <script src="https://cdn.jsdelivr.net/vue.resource/1.2.1/vue-resource.min.js"></script>
        <script src="{% static 'annotations/js/cytoscape.min.js' %}"></script>
        <!-- <script src="https://unpkg.com/vue/dist/vue.js"></script> -->
        <style>

            .main {
                min-height: 1000px;
            }
            #text-content {
                padding: 10px;
            }
            .appellation {
                border: 0.5px solid orange;
                background-color: yellow;
                opacity: 0.2;
                list-style-type: none;
                margin: 0;
                padding: 0;
                cursor: pointer;
            }
            .date-appellation {
                border: 0.5px solid green;
                background-color: green;
                opacity: 0.2;
                list-style-type: none;
                margin: 0;
                padding: 0;
                cursor: pointer;
            }

            .relation-list {
                font-size: 0.8em;
            }
            .relation-list .btn {
                font-size: 1em;
            }
            .relation-list-item {
                font-size: 1em;
                padding: 5px;
            }


            .appellation.appellation-selected {
                border: 2px solid orange;
                background-color: orange;
                opacity: 0.6;
            }
            .date-appellation.appellation-selected {
                border: 2px solid green;
                background-color: green;
                opacity: 0.6;
            }
            .appellation-list {
                font-size: 0.8em;
            }
            .appellation-list .btn {
                font-size: 1em;
            }
            .appellation-list-item {
                font-size: 1em;
                padding: 5px;
            }
            .appellation-list-item.appellation-selected {
                background-color: rgba(255, 165, 0, 0.5);
            }
            .text-selection {
                border: 0.5px solid blue;
                background-color: blue;
                opacity: 0.2;
                list-style-type: none;
                margin: 0;
                padding: 0;
            }

            .concept-item {
                padding: 5px;
                font-size: 8pt;
            }
            .concept-search-list-group {
                max-height: 300px;
                overflow-y: scroll;
            }


            #text-content {
                font-size: 0.9em;
            }

            .appellation-type-selector {
                margin-bottom: 5px;
                margin-top: 5px;
            }

            .appellation-creator {
                font-size: 0.8em;
                padding: 5px;
                border: 0.5px solid #ddd;
            }
            .appellation-creator .form-control {
                font-size: 1.0em;
            }
            .appellation-creator-representation {
                font-style: italic;
                color: #6d6d6d;
            }
            .appellation-creator-offsets {
                font-weight:bold;
            }

            .relation-form {
                font-size: 0.8em;
            }
            .relation-form .form-control {
                font-size: 1.0em;
            }

            .relation-template-selector {
                font-size: 0.8em;
            }
            .relationtemplate-item {
                cursor: pointer;
                padding: 3px;
                margin-bottom: 0px;
                border: none;
            }
            .relation-template-selector .form-group {
                .font-size: 1em;
            }
            .relation-field {
                margin-bottom: 5px;
            }

            .action-column {
                background-color: white;

                border-left: 1px solid #ddd;
                border-right: 1px solid #ddd;
                border-bottom: 1px solid #ddd;
                padding-top: 10px;
                padding-left: 5px;
                padding-right: 5px;
                padding-bottom: 10px;
            }

            .date-selector {
                margin-top: 8px;
                margin-bottom: 8px;
            }

            .relation-date-bits {
                font-size: 0.8em;
            }

            .relation-creator {
                padding: 5px;
                border: 0.5px solid #ddd;
            }

            .sidebar-buttons {
                margin-bottom: 5px;
            }

            .annotation-preamble {
                padding: 10px;
                border-bottom: 1px solid #ddd;
            }


            /*********** Tooltips! ***********/
            .tooltip {
                display: none;
                opacity: 0;
                transition: opacity .15s;
                pointer-events: none;
                padding: 4px;
                z-index: 10000;
              }
              .tooltip .tooltip-content {
                background-color: #ddd;
                color: black;
                border-radius: 5px;
                border: 1px solid gray;
                padding: 3px 5px 2px;
              }
              .tooltip.tooltip-open-transitionend {
                display: block;
              }
              .tooltip.tooltip-after-open {
                opacity: 1;
              }
        </style>
        {% endblock %}
    <!-- </head> -->
    {% block main %}
    <body>
        <div class="row">
            <div class="col-xs-12" id="tabGraph">
                <div id="graphContainer" style="height: 100px; padding:5px; resize: vertical; overflow: auto; border: 1px solid #ddd; margin: 5px;">
                    <div id="graph"  style="height: 100%;"></div>
                </div>
            </div>
        </div>

        <div class="container-fluid" id="main-container">
            <div class="row">
                <div class="col-xs-12">
                    {% include "annotations/text/preamble.html" %}
                </div>
            </div>
                <div id="appellator">
                    <conductor></conductor> <!-- The appellator interface is inserted here. -->
                </div>
                <script id="annotation-template" type="text/x-template">

                    <div class="container-fluid">
                        <div class="row">

                            <div v-bind:class="{
                                    'col-sm-7': true
                                }"
                                style="padding: 3px;">
                                <text-display
                                    v-bind:appellations=appellations
                                    v-bind:dateappellations=dateappellations
                                    v-on:selectappellation="selectAppellation"
                                    v-on:selectdateappellation="selectDateAppellation"
                                    v-on:selecttext="selectText">
                                </text-display>
                            </div>
                            <div id="sticky-swimlane" v-bind:class="{
                                    'col-sm-4': !sidebarIsShown(),
                                    'col-sm-3': sidebarIsShown(),
                                    'action-column': true
                                }">
                                <div>
                                    <relation-template-selector
                                        v-if="template == null && creating_relation"
                                        v-on:selectedtemplate="selectedTemplate">
                                    </relation-template-selector>
                                    <relation-creator
                                        v-if="template != null && creating_relation"
                                        v-on:fieldislisteningfortext="fieldIsListeningForText"
                                        v-on:fieldisdonelisteningfortext="fieldIsDoneListeningForText"
                                        v-on:createdrelation="createdRelation"
                                        v-on:cancelrelation="cancelRelation"
                                        v-bind:user=user
                                        v-bind:text=text
                                        v-bind:template=template
                                        v-bind:project=project>
                                    </relation-creator>
                                    <div class="appellation-type-selector text-right" v-if="textIsSelected()">
                                        <a v-bind:class="{
                                                btn: true,
                                                'btn-sm': true,
                                                'btn-success': !create_date_appellation,
                                                'btn-default': create_date_appellation
                                            }"
                                            v-tooltip="'Concept'"
                                            v-on:click="toggleDateAppellation">
                                            <span class="glyphicon glyphicon-grain"></span>
                                        </a>
                                        <a v-bind:class="{
                                                btn: true,
                                                'btn-sm': true,
                                                'btn-success': create_date_appellation,
                                                'btn-default': !create_date_appellation
                                            }"
                                            v-tooltip="'Date'"
                                            v-on:click="toggleDateAppellation">
                                            <span class="glyphicon glyphicon-calendar"></span>
                                        </a>
                                    </div>
                                    <date-appellation-creator
                                        v-if="textIsSelected() && create_date_appellation"
                                        v-bind:user=user
                                        v-bind:text=text
                                        v-bind:project=project
                                        v-bind:position=selected_text
                                        v-on:createddateappellation="createdDateAppellation"
                                        v-on:cancelappellation="cancelAppellation"
                                        v-on:createdappellation="createdAppellation">
                                    </date-appellation-creator>
                                    <appellation-creator
                                        v-if="textIsSelected() && !create_date_appellation"
                                        v-bind:user=user
                                        v-bind:text=text
                                        v-bind:project=project
                                        v-bind:position=selected_text
                                        v-on:cancelappellation="cancelAppellation"
                                        v-on:createdappellation="createdAppellation">
                                    </appellation-creator>
                                </div>
                            </div>
                            <div v-bind:class="{
                                        'col-sm-1': !sidebarIsShown(),
                                        'col-sm-2': sidebarIsShown()
                                    }"
                                 style="padding: 3px;">
                                <div class="container-fluid">
                                    <div class="row">
                                        <div v-if="sidebarIsShown()" class="col-xs-12" style="padding: 0px;">
                                            <div class="clearfix sidebar-buttons">
                                                <a v-if="sidebarIsShown()" class="btn" v-on:click="hideSidebar"  style="padding: 2px;">
                                                    <span class="glyphicon glyphicon-chevron-right"></span>
                                                </a>
                                                <div class="pull-right btn-group">
                                                    <a  v-tooltip="'Appellations'"
                                                        v-bind:class="{
                                                                btn: true,
                                                                'btn-success': sidebar == 'appellations',
                                                                'btn-default': sidebar != 'appellations'
                                                            }"
                                                        v-on:click="showAppellationsSidebar">
                                                        <span class="glyphicon glyphicon-tag"></span>
                                                    </a>
                                                    <a  v-tooltip="'Date Appellations'"
                                                        v-bind:class="{
                                                                btn: true,
                                                                'btn-success': sidebar == 'dateappellations',
                                                                'btn-default': sidebar != 'dateappellations'
                                                            }"
                                                        v-on:click="showDateAppellationsSidebar">
                                                        <span class="glyphicon glyphicon-calendar"></span>
                                                    </a>
                                                    <a v-tooltip="'Relations'"
                                                        v-bind:class="{
                                                                btn: true,
                                                                'btn-success': sidebar == 'relations',
                                                                'btn-default': sidebar != 'relations'
                                                            }"
                                                        v-on:click="showRelationsSidebar">
                                                        <span class="glyphicon glyphicon-th-list"></span>
                                                    </a>
                                                </div>
                                            </div>
                                            <relation-list
                                                v-if="sidebar == 'relations'"
                                                v-bind:relations=relations
                                                v-on:selectrelation="selectRelation">
                                            </relation-list>
                                            <appellation-list
                                                v-if="sidebar == 'appellations'"
                                                v-bind:appellations=appellations
                                                v-on:hideallappellations="hideAllAppellations"
                                                v-on:showallappellations="showAllAppellations"
                                                v-on:showappellation="showAppellation"
                                                v-on:hideappellation="hideAppellation"
                                                v-on:selectappellation="selectAppellation">
                                            </appellation-list>
                                            <appellation-list
                                                v-if="sidebar == 'dateappellations'"
                                                v-bind:appellations=dateappellations
                                                v-on:hideallappellations="hideAllDateAppellations"
                                                v-on:showallappellations="showAllDateAppellations"
                                                v-on:showappellation="showDateAppellation"
                                                v-on:hideappellation="hideDateAppellation"
                                                v-on:selectappellation="selectDateAppellation">
                                            </appellation-list>
                                        </div>
                                        <div v-else class="col-xs-12">
                                            <a class="btn" v-on:click="showSidebar" style="padding: 2px;">
                                                <span class="glyphicon glyphicon-chevron-left"></span>
                                            </a>
                                        </div>

                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </script>
            </div>

          <script src="https://unpkg.com/tether"></script>
          <script src="https://unpkg.com/tether-drop"></script>
          <script src="https://unpkg.com/tether-tooltip"></script>
          <script src="{% static "annotations/js/v-tooltip.browser.js" %}"></script>

         <script>
            var TEXT_ID = '{{ text.id }}';
            var TEXT_TITLE = '{{ text.title }}';
            var USER_ID = '{{ user.id }}';
            var USER_NAME = '{{ user.username }}';
            var PROJECT_ID = '{{ project.id }}';
            var PROJECT_NAME = '{{ project.name }}';
            var TEXT_CONTENT = `{{ content }}`;
            var BASE_URL = '{{ base_url }}';

        // Appellator is the text annotation application. Even though we load
        //  is later on, we want it in scope for node events in the Cytoscape
        //  visualization.
        var Appellator;

        var reloadGraph = function() {
            var cy;
            $.ajax('{% url "network_for_text" text.id %}?user={{ user.id }}&project={{ project.id }}', {
                // When the data is returned, generate an interative visualization
                //  using Cytoscape.js.
                success: function(data) {
                    if (data.elements.length == 0) {
                        return;
                    }
                    // Normalize node and edge weights.
                    var minEdgeWeight = 1.0;
                    var maxEdgeWeight = 0.0;
                    var minNodeWeight = 1.0;
                    var maxNodeWeight = 0.0;

                    data.elements.forEach(function(elem) {
                        var weight = Number(elem.data.weight);
                        if (elem.data.source) {  // Edge.
                            if (weight > maxEdgeWeight) maxEdgeWeight = weight;
                            if (weight < minEdgeWeight) minEdgeWeight = weight;
                        } else {
                            if (weight > maxNodeWeight) maxNodeWeight = weight;
                            if (weight < minNodeWeight) minNodeWeight = weight;
                        }
                    });

                    // If min and max are the same, cytoscape will throw a TypeError,
                    //  so we decrement the min values just to be safe.
                    minNodeWeight = Number(minNodeWeight.toPrecision(4)) - 1;
                    maxNodeWeight = Number(maxNodeWeight.toPrecision(4));
                    minEdgeWeight = Number(minEdgeWeight.toPrecision(4)) - 1;
                    maxEdgeWeight = Number(maxEdgeWeight.toPrecision(4));
                    var currentHeight = $('#graph').height();
                    var currentWidth = $('#graph').width();
                    cy = cytoscape({
                        container: $('#graph'),
                        elements: data.elements,
                        zoom: 1,
                        minZoom: 0.1,
                        maxZoom: 3,
                        panningEnabled: true,
                        style: [    // The stylesheet for the graph.
                            {   // Node size is a function of topic prevalence.
                                selector: 'node',
                                style: {
                                    'background-color': '#B74934',
                                    'label': 'data(label)',
                                    'width': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 15, 45)',
                                    'height': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 15, 45)',
                                    'font-size': 'mapData(weight, ' + minNodeWeight + ', ' + maxNodeWeight + ', 8, 36)'
                                }
                            }, {
                                selector: 'node.connectedNodes',
                                style: {
                                    'opacity': 1.0,
                                    'border-color': '#AA9A66',
                                    'border-width': 2,
                                    'width': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 25, 55)',
                                    'height': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 25, 55)',
                                    'font-size': 'mapData(weight, ' + minNodeWeight + ', ' + maxNodeWeight + ', 8, 20)'
                                }
                            }, {
                                selector: 'node.nonConnectedNodes',
                                style: {
                                    'opacity': 0.5,
                                }
                            }, { // When a node is selected, it should be slightly larger and have a colored border.
                                selector: 'node:selected',
                                style: {
                                    'border-color': '#AA9A66',
                                    'border-width': 4,
                                    'font-size': 'mapData(weight, ' + minNodeWeight + ', ' + maxNodeWeight + ', 10, 35)',
                                    'width': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 60, 90)',
                                    'height': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 60, 90)',
                                }
                            }, { // Active nodes should be slightly larger.
                                selector: 'node:active',
                                style: {
                                    'width': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 30, 60)',
                                    'height': 'mapData(weight, ' + minNodeWeight  + ', ' + maxNodeWeight + ', 30, 60)',
                                }
                            }, { // Edge weight is a function of nPMI.
                                selector: 'edge',
                                style: {
                                    'width': 'mapData(weight, ' + minEdgeWeight  + ', ' + maxEdgeWeight + ', 0.5, 6)',
                                    'opacity': 'mapData(weight, 0.01, 0.5, 0.1, 1)',
                                    'line-color': '#67655D',
                                    'target-arrow-color': '#ccc',
                                },
                            }, {
                                selector: 'edge.connectedEdge',
                                style: {
                                    'opacity': 1,
                                    'line-color': '#AA9A66',
                                    'z-index': 500,
                                    'width': 'mapData(weight, ' + minEdgeWeight  + ', ' + maxEdgeWeight + ', 1, 12)',
                                }
                            }, {
                                // A selected edge should be slightly thicker, and be colored a brighter color.
                                selector: 'edge:selected',
                                style: {
                                    'width': 'mapData(weight, ' + minEdgeWeight  + ', ' + maxEdgeWeight + ', 2, 8)',
                                    'opacity': 1,
                                    'line-color': '#AA9A66',
                                }
                            }
                        ],
                        layout: {
                          name: 'cose',
                        //   rows: 1,
                        //   ready               : function() {},
                        //   stop                : function() {},
                        //   animate             : true,
                        //   animationThreshold  : 250,
                        //   refresh             : 20,
                        //   fit                 : true,
                          padding             : 0,
                          boundingBox         :  { x1: 0, y1: 0, w: currentWidth, h: currentHeight},
                        //   componentSpacing    : 100,
                        //   nodeRepulsion       : function( node ){ return 40; },
                        //   nodeOverlap         : 10,
                        //   idealEdgeLength     : function( edge ){ return 10; },
                        //   edgeElasticity      : function( edge ){ return 100; },
                        //   nestingFactor       : 5,
                        //   gravity             : 80,
                        //   numIter             : 1000,
                        //   initialTemp         : 200,
                        //   coolingFactor       : 0.95,
                        //   minTemp             : 1.0,
                        //   useMultitasking     : true
                        }
                    });

                    // We just want to give a visual indication of which appellations'
                    //  are related to each node. Selecting appellations doesn't really
                    //  make sense, because there can be several appellations per node
                    //  (nodes represent concepts).
                    cy.on('select', 'node', function(event) {
                        var node = event.cyTarget;
                        if (Appellator) {
                            Appellator.selectAppellationsById(node._private.data.appellations);
                        }
                    });
                    cy.on('unselect', 'node', function(event) {
                        var node = event.cyTarget;
                        if (Appellator) {
                            Appellator.unselectAppellation();
                        }
                    });

                }
            });


            var resizeGraph = function() {
                if (cy) {
                    cy.resize();
                    cy.fit();
                }
            }
            $(window).resize(resizeGraph);

            var graphContainerHeight = $('#graphContainer').height();
            // We can't bind the #graphContainer resize directly, so let's
            //  check for height changes on mouseup.
            $(document).mouseup(function(e) {   // The mouseup can happen anywhere.
                var currentHeight = $('#graphContainer').height();
                if (currentHeight != graphContainerHeight) {
                    graphContainerHeight = currentHeight;
                    resizeGraph();
                }
            });
        }

        $('body').ready(reloadGraph);

        </script>

        <script src="{% static "annotations/js/annotator/annotator.js" %}"></script>
    </body>
    {% endblock %}
<!-- </html> -->
